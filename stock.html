<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IMS ‚Äî Dashboard & Profile (Demo) ‚Äî Updated</title>
  <style>
    :root{--bg:#f6f8fb;--card:#ffffff;--accent:#2563eb;--accent-2:#1e40af;--muted:#6b7280;--text:#111;--filter-bg:#f1f5f9;--filter-accent:#eef2ff}
    [data-theme="dark"]{--bg:#0b1020;--card:#071025;--accent:#60a5fa;--accent-2:#2563eb;--muted:#9ca3af;--text:#e6eef8;--filter-bg:#071426;--filter-accent:#062036}
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    body{margin:0;background:var(--bg);color:var(--text)}
    .app{display:flex;min-height:100vh}
    /* Sidebar */
    .sidebar{width:250px;background:linear-gradient(180deg,#0f172a,#0b1220);color:#fff;padding:18px 16px;transition:width .32s cubic-bezier(.2,.9,.2,1),padding .32s ease;overflow:hidden}
    .sidebar.collapsed{width:72px;padding:12px 10px}
    .brand-row{display:flex;align-items:center;gap:12px}
    .hamburger{width:36px;height:36px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.03)}
    .brand-full{font-weight:700;font-size:18px;margin-bottom:6px;white-space:nowrap;transition:opacity .22s,transform .22s}
    .brand-short{font-weight:700;font-size:18px;margin-bottom:6px;white-space:nowrap;opacity:0;transform:translateX(-6px);transition:opacity .22s,transform .22s}
    #sidebarSubtitle{color:var(--muted);font-size:13px;transition:opacity .22s,transform .22s}
    .muted{color:var(--muted)}
    .nav{margin-top:12px}

    /* nav items with icon + label; icons shown when collapsed */
    .nav a{display:flex;align-items:center;padding:10px 12px;border-radius:8px;color:#dbeafe;text-decoration:none;margin-bottom:6px;cursor:pointer;gap:12px;transition:background .12s,transform .12s}
    .nav a .icon{width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center;font-size:18px}
    .nav a .label{display:inline-flex;align-items:center;opacity:1;transform:translateX(0);transition:opacity .22s,transform .22s,margin .22s}
    .sidebar.collapsed .nav a{justify-content:center;padding:10px}
    .sidebar.collapsed .nav a .icon{display:inline-flex}
    .sidebar.collapsed .nav a .label{opacity:0;transform:translateX(-8px);pointer-events:none;width:0;margin:0;padding:0}

    .nav a.active{background:rgba(255,255,255,0.06)}
    .nav a:hover{background:rgba(255,255,255,0.03)}
    /* Main */
    .main{flex:1;padding:18px}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .search{display:flex;gap:8px;align-items:center}
    .search input{padding:8px 12px;border-radius:10px;border:1px solid #e6eef8;min-width:220px}
    .cards{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:18px}

    /* Card styles (each box) */
    .card{background:linear-gradient(180deg,var(--card),#fbfdff);padding:16px;border-radius:14px;box-shadow:0 8px 24px rgba(2,6,23,0.04);border:1px solid rgba(15,23,42,0.03);transition:transform .14s ease,box-shadow .14s ease}
    .card:hover{transform:translateY(-6px);box-shadow:0 18px 36px rgba(2,6,23,0.06)}
    .card h4{margin:0;font-size:13px;color:var(--muted)}
    .card p{margin:8px 0 0;font-weight:700;font-size:18px}

    /* Content areas */
    .panel{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.04);border:1px solid rgba(15,23,42,0.02)}
    .panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;text-align:left;border-bottom:1px solid #f1f5f9}
    th{font-size:13px;color:var(--muted)}
    .toolbar{display:flex;gap:8px;align-items:center}

    /* Button improvements */
    .btn{padding:8px 14px;border-radius:10px;border:none;background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff;cursor:pointer;font-weight:600;box-shadow:0 6px 18px rgba(37,99,235,0.12);transition:transform .12s ease,box-shadow .12s ease}
    .btn:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(37,99,235,0.16)}
    .btn:active{transform:translateY(0)}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(255,255,255,0.08);box-shadow:none;font-weight:600}
    .btn.ghost:hover{background:rgba(255,255,255,0.02)}

    .floating{position:fixed;right:28px;bottom:28px;background:var(--accent);color:#fff;padding:14px;border-radius:50%;font-weight:700;box-shadow:0 10px 30px rgba(2,6,23,0.2);cursor:pointer}

    /* Filters: attractive filter box styles */
    .filters{display:flex;gap:12px;align-items:center}
    .filters select{appearance:none;-webkit-appearance:none;padding:10px 14px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);background:var(--filter-bg);min-width:180px;box-shadow:inset 0 -1px 0 rgba(255,255,255,0.02);font-weight:600;color:var(--text);cursor:pointer}
    .filters select:focus{outline:none;box-shadow:0 6px 18px rgba(37,99,235,0.06)}
    .filters select::-ms-expand{display:none}
    .filter-wrapper{display:flex;align-items:center;gap:8px;padding:6px;background:linear-gradient(180deg,var(--filter-bg),var(--filter-accent));border-radius:12px;border:1px solid rgba(15,23,42,0.03)}
    .filter-label{font-size:13px;color:var(--muted);margin-right:6px}

    /* product grid (boxed products on dashboard) */
    .product-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px}
    .product-box{background:linear-gradient(180deg,var(--card),#fbfdff);border-radius:12px;padding:14px;box-shadow:0 8px 20px rgba(2,6,23,0.04);display:flex;justify-content:space-between;align-items:center;gap:12px;border:1px solid rgba(15,23,42,0.03);transition:transform .12s ease,box-shadow .12s ease}
    .product-box:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(2,6,23,0.06)}
    .product-meta{display:flex;flex-direction:column}
    .product-name{font-weight:700}
    .product-sku{font-size:13px;color:var(--muted)}
    .qty-badge{background:linear-gradient(180deg,#eef2ff,#f8fbff);padding:8px 12px;border-radius:999px;font-weight:800;color:var(--accent);border:1px solid rgba(37,99,235,0.06)}
    .product-actions button{margin-left:8px}

    /* small inline qty next to add fields */
    .inline-qty{display:inline-flex;align-items:center;gap:8px;margin-left:8px}
    .inline-qty .qty-display{background:#eef2ff;padding:4px 8px;border-radius:8px;font-weight:700;color:var(--accent)}

    /* profile */
    .profile{display:grid;grid-template-columns:260px 1fr;gap:14px}
    .profile-card{padding:18px;border-radius:12px;background:var(--card);box-shadow:0 6px 18px rgba(15,23,42,0.04);text-align:center}
    .avatar{width:120px;height:120px;border-radius:12px;background:linear-gradient(135deg,#e6eef8,#dbeafe);display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:34px;color:var(--accent);margin-bottom:8px}
    .profile-details{padding:18px;background:var(--card);border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.04)}
    .field{Display:flex;gap:12px;align-items:center;margin-bottom:10px}
    .field label{width:120px;color:var(--muted)}
    .activity{max-height:220px;overflow:auto}
    /* My Cart / Orders special style */
    .special{display:grid;grid-template-columns:1fr 320px;gap:12px}
    .cart-panel{background:linear-gradient(180deg,#fff,#f8fafc);padding:14px;border-radius:12px}

    /* responsive */
    @media (max-width:1000px){.cards{grid-template-columns:repeat(2,1fr)}.sidebar{display:none}.app{flex-direction:column}.main{padding:12px}.profile{grid-template-columns:1fr}.product-grid{grid-template-columns:repeat(2,1fr)}}

    /* hide product sku when sidebar is collapsed so the compact nav doesn't expose extra text */
    .sidebar.collapsed ~ .main .product-sku{display:none}

    /* small helpers */
    .small{font-size:13px;color:var(--muted)}
    .switch{display:inline-flex;align-items:center;gap:8px}
    .switch input{width:0;height:0;opacity:0}
    .switch .track{width:44px;height:24px;background:#ccc;border-radius:999px;position:relative}
    .switch .thumb{position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:#fff;transition:all .2s}
    .switch input:checked + .track{background:var(--accent)}
    .switch input:checked + .track .thumb{left:23px}
  </style>
</head>
<body id="bodyRoot">
  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="brand-row">
        <div class="hamburger" id="hamburger" title="Toggle sidebar" aria-expanded="true">
          <!-- three lines -->
          <svg width="18" height="12" viewBox="0 0 18 12" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="18" height="2" rx="1" fill="white"/><rect y="5" width="18" height="2" rx="1" fill="white"/><rect y="10" width="18" height="2" rx="1" fill="white"/></svg>
        </div>
        <div>
          <div class="brand-full">StockMaster ‚Äî IMS</div>
          <div class="brand-short" style="display:none">IMS</div>
          <div id="sidebarSubtitle" class="small">Inventory Management System</div>
        </div>
      </div>
      <div style="height:8px"></div>
      <nav class="nav" id="mainNav">
        <!-- removed Home as requested; added icons for collapsed state -->
        <a data-view="dashboard" class="active"><span class="icon">üìä</span><span class="label">Dashboard</span></a>
        <a data-view="products"><span class="icon">üì¶</span><span class="label">Products</span></a>
        <a data-view="receipts"><span class="icon">üßæ</span><span class="label">Receipts</span></a>
        <a data-view="deliveries"><span class="icon">üöö</span><span class="label">Delivery Orders</span></a>
        <a data-view="transfers"><span class="icon">üîÅ</span><span class="label">Transfers</span></a>
        <a data-view="mycart"><span class="icon">üõí</span><span class="label">My Cart</span></a>
        <a data-view="myorders"><span class="icon">üìú</span><span class="label">My Orders</span></a>
        <a data-view="settings"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a>
      </nav>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="search">
          <input id="search" placeholder="Search SKU, product name..." />
          <div class="muted">Role: Inventory Manager</div>
        </div>
        <div class="toolbar">
          <button class="btn ghost" id="btnAddProduct">+ Product</button>
          <button class="btn ghost" id="btnAddReceipt">+ Receipt</button>
          <button class="btn" id="btnAddDelivery">+ Delivery</button>
        </div>
      </div>

      <!-- Views container -->

      <!-- Home: consolidated overview (cards + products + quick receipts/deliveries) -->
      <section id="view-home" class="view" style="display:none">
        <section class="cards">
          <div class="card"><h4>Total Products</h4><p id="home_kpiproducts">0</p></div>
          <div class="card"><h4>Low Stock</h4><p id="home_kpilow">0</p></div>
          <div class="card"><h4>Pending Receipts</h4><p id="home_kpipendrec">0</p></div>
          <div class="card"><h4>Pending Deliveries</h4><p id="home_kpipenddel">0</p></div>
          <div class="card"><h4>Transfers</h4><p id="home_kpitrans">0</p></div>
        </section>

        <section class="panel">
          <div class="panel-header">
            <h3>Quick Inventory</h3>
            <div class="filters">
              <select id="home_filterLocation"><option value="all">All locations</option><option value="main">Main Warehouse</option><option value="prod">Production Rack</option></select>
              <select id="home_filterCategory"><option value="all">All categories</option><option value="raw">Raw Material</option><option value="finished">Finished Goods</option></select>
            </div>
          </div>

          <div id="homeProductGrid" class="product-grid"></div>

          <div style="display:flex;gap:12px;margin-top:12px">
            <div class="panel" style="flex:1"><h4>Receipts (recent)</h4><div id="homeReceipts" class="muted">No recent receipts</div></div>
            <div class="panel" style="flex:1"><h4>Deliveries (recent)</h4><div id="homeDeliveries" class="muted">No recent deliveries</div></div>
          </div>
        </section>
      </section>
      <section id="view-dashboard" class="view">
        <section class="cards">
          <div class="card"><h4>Total Products</h4><p id="kpiproducts">0</p></div>
          <div class="card"><h4>Low Stock</h4><p id="kpilow">0</p></div>
          <div class="card"><h4>Pending Receipts</h4><p id="kpipendrec">0</p></div>
          <div class="card"><h4>Pending Deliveries</h4><p id="kpipenddel">0</p></div>
          <div class="card"><h4>Transfers</h4><p id="kpitrans">0</p></div>
        </section>

        <section class="panel">
          <div class="panel-header">
            <h3>Products (boxed)</h3>
            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
              <div class="filters">
                <select id="filterLocation"><option value="all">All locations</option><option value="main">Main Warehouse</option><option value="prod">Production Rack</option></select>
                <select id="filterCategory"><option value="all">All categories</option><option value="raw">Raw Material</option><option value="finished">Finished Goods</option></select>
                
              </div>
              

          <!-- Product grid: boxed product cards (dashboard) -->
          <div id="productGrid" class="product-grid"></div>

          <!-- keep old table for Products view (unchanged) -->
        </section>
      </section>

      <!-- Profile view -->
      <section id="view-profile" class="view" style="display:none">
        <div class="profile">
          <div class="profile-card">
            <div id="avatar" class="avatar">RK</div>
            <div style="font-weight:700;font-size:18px;margin-top:6px" id="u_name">Rohit Koli</div>
            <div class="muted" id="u_role">Inventory Manager</div>
            <div style="margin-top:12px"><button class="btn ghost" id="btnEditProfile">Edit Profile</button></div>
            <hr style="margin:14px 0;border:none;border-top:1px solid #f1f5f9" />
            <div style="text-align:left">
              <div class="muted" style="font-size:13px;margin-bottom:8px">Quick Actions</div>
              <button class="btn" id="btnReceiveGoods">Receive Goods</button>
              <button class="btn ghost" id="btnShipGoods">Ship Goods</button>
            </div>
          </div>

          <div class="profile-details">
            <h3>Profile Details</h3>
            <div class="field"><label>Name</label><div id="u_name_f" class="muted">Rohit Koli</div></div>
            <div class="field"><label>Email</label><div id="u_email_f" class="muted">rohit@example.com</div></div>
            <div class="field"><label>Role</label><div id="u_role_f" class="muted">Inventory Manager</div></div>
            <div class="field"><label>Bio</label><div id="u_bio_f" class="muted">Keeps the shelves tidy and the records tidy-er.</div></div>

            <h4 style="margin-top:12px">Recent Activity</h4>
            <div class="activity" id="activityList"></div>

            <h4 style="margin-top:12px">Security</h4>
            <div class="field"><label>Password</label><div class="muted">Last changed: <span id="pw_changed">‚Äî</span></div></div>
            <div style="text-align:right;margin-top:12px"><button class="btn ghost" id="btnChangePassword">Change Password</button></div>
          </div>
        </div>
      </section>

      <!-- Products view: keep table (unchanged) -->
      <section id="view-products" class="view" style="display:none">
        <div class="panel"><h3>Products</h3>
          <p class="muted">(same table as dashboard ‚Äî boxed view kept on dashboard)</p>
          <table id="productTable">
            <thead><tr><th>Name</th><th>SKU</th><th>Category</th><th>Unit</th><th>Stock</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="view-receipts" class="view" style="display:none"><div class="panel"><h3>Receipts</h3><p class="muted">(list receipts)</p></div></section>
      <section id="view-deliveries" class="view" style="display:none"><div class="panel"><h3>Deliveries</h3><p class="muted">(list deliveries)</p></div></section>
      <section id="view-transfers" class="view" style="display:none"><div class="panel"><h3>Transfers</h3><p class="muted">(list transfers)</p></div></section>

      <!-- My Cart (special) -->
      <section id="view-mycart" class="view" style="display:none">
        <div class="panel special">
          <div>
            <h3>My Cart</h3>
            <p class="muted">Items you've added for quick dispatch.</p>
            <div id="cartList"></div>
          </div>
          <div class="cart-panel">
            <h4>Summary</h4>
            <div id="cartSummary">No items</div>
            <div style="margin-top:12px;text-align:right"><button class="btn">Checkout</button></div>
          </div>
        </div>
      </section>

      <!-- My Orders (special) -->
      <section id="view-myorders" class="view" style="display:none">
        <div class="panel">
          <h3>My Orders</h3>
          <p class="muted">Historical orders and statuses.</p>
          <div id="ordersList"></div>
        </div>
      </section>

      <!-- Settings: include Profile tab under settings as requested -->
      <section id="view-settings" class="view" style="display:none">
        <div class="panel">
          <h3>Settings</h3>
          <p class="muted">App settings</p>

          <hr style="margin:12px 0" />
          <h4>Profile (quick)</h4>
          <div style="display:flex;gap:12px;align-items:center">
            <div style="min-width:80px"><div id="settings_avatar" class="avatar">RK</div></div>
            <div>
              <div id="settings_name" style="font-weight:700">Rohit Koli</div>
              <div class="muted" id="settings_role">Inventory Manager</div>
              <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
                <button class="btn ghost" id="btnLoginProfile">Login / My Profile</button>
                <button class="btn ghost" id="btnOpenFullProfile">Open Full Profile</button>
              </div>
            </div>
          </div>

          <hr style="margin:12px 0" />
          <h4>Appearance</h4>
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <div class="small">Dark theme</div>
              <div class="small muted">Toggle application dark mode</div>
            </div>
            <label class="switch"><input type="checkbox" id="themeToggle" /><span class="track"><span class="thumb"></span></span></label>
          </div>

        </div>
      </section>

      <div class="floating" title="Quick add" id="btnQuick">+</div>

    </main>
  </div>

  <!-- modal backdrop -->
  <div id="modalBack" class="modal-back" style="position:fixed;inset:0;background:rgba(2,6,23,0.4);display:none;align-items:center;justify-content:center">
    <div class="modal" id="modalContent" style="background:var(--card);padding:18px;border-radius:12px;min-width:360px">
      <!-- dynamic content inserted by JS -->
    </div>
  </div>

  <script>
    // Simple in-memory data store (demo) with a user
    const store = {
      user: {id:1,name:'Rohit Koli',email:'rohit@example.com',role:'Inventory Manager',bio:'Keeps the shelves tidy and the records tidy-er.',avatar:null,password_changed:new Date().toLocaleString()},
      products: [
        {id:1,name:'Steel Rods',sku:'ST-001',category:'raw',unit:'kg',stock:127,locations:{main:127,prod:0}},
        {id:2,name:'Wooden Chair',sku:'CH-101',category:'finished',unit:'pcs',stock:43,locations:{main:10,prod:33}},
        {id:3,name:'Nails Pack',sku:'NA-09',category:'raw',unit:'box',stock:8,locations:{main:8,prod:0}},
      ],
      receipts:[],deliveries:[],transfers:[],history:[{type:'login',text:'Logged in'},{type:'receipt',text:'Received 20 √ó Steel Rods'},{type:'delivery',text:'Shipped 3 √ó Wooden Chair'}],
      cart:[],orders:[]
    }

    // Utility
    const el = (s)=>document.querySelector(s)
    const elAll = (s)=>document.querySelectorAll(s)

    // attach navigation handlers
    document.querySelectorAll('.nav a').forEach(a=>a.addEventListener('click', ()=>{ const view = a.dataset.view; switchView(view); }))

    // wire topbar and repeated buttons (use IDs to avoid inline onclick and allow bundling after functions defined)
    document.getElementById('btnAddProduct').addEventListener('click', ()=>openModal('product'))
    document.getElementById('btnAddReceipt').addEventListener('click', ()=>openModal('receipt'))
    document.getElementById('btnAddDelivery').addEventListener('click', ()=>openModal('delivery'))
    document.getElementById('btnQuick').addEventListener('click', ()=>openModal('quick'))
    document.getElementById('btnEditProfile').addEventListener('click', ()=>openModal('editProfile'))
    document.getElementById('btnReceiveGoods').addEventListener('click', ()=>openModal('receipt'))
    document.getElementById('btnShipGoods').addEventListener('click', ()=>openModal('delivery'))
    document.getElementById('btnChangePassword').addEventListener('click', ()=>openModal('changePassword'))
    document.getElementById('btnLoginProfile').addEventListener('click', ()=>openModal('editProfile'))
    document.getElementById('btnOpenFullProfile').addEventListener('click', ()=>switchView('profile'))

    // hamburger (toggle collapse) and subtitle click behavior
    const hamburger = document.getElementById('hamburger')
    const sidebar = document.getElementById('sidebar')
    const subtitle = document.getElementById('sidebarSubtitle')
    hamburger.addEventListener('click', ()=>{
      // toggle collapsed class only; CSS handles transitions for labels/brand
      const collapsed = sidebar.classList.toggle('collapsed')
      hamburger.setAttribute('aria-expanded', String(!collapsed))
      // ensure no inline display styles remain (prevent glitches)
      const brandFull = document.querySelector('.brand-full')
      const brandShort = document.querySelector('.brand-short')
      const subtitleEl = document.getElementById('sidebarSubtitle')
      if(brandFull) brandFull.style.opacity = ''
      if(brandShort) brandShort.style.opacity = ''
      if(subtitleEl) subtitleEl.style.opacity = ''
    })

    // Theme handling
    const bodyRoot = document.getElementById('bodyRoot')
    const themeToggle = document.getElementById('themeToggle')
    function applyTheme(dark){
      if(dark){ document.documentElement.setAttribute('data-theme','dark'); themeToggle.checked = true } else { document.documentElement.removeAttribute('data-theme'); themeToggle.checked = false }
      try{ localStorage.setItem('sm_dark', dark ? '1' : '0') }catch(e){}
    }
    // initialize theme from localStorage
    try{ const v = localStorage.getItem('sm_dark'); applyTheme(v==='1') }catch(e){ applyTheme(false) }
    themeToggle.addEventListener('change', ()=>{ applyTheme(themeToggle.checked) })

    function switchView(view){
      if(!view) return
      document.querySelectorAll('.nav a').forEach(a=>a.classList.toggle('active', a.dataset.view===view))
      document.querySelectorAll('.view').forEach(v=>v.style.display=(v.id==='view-'+view)?'block':'none')
      if(view==='home'){ renderHome() }
      if(view==='dashboard'){ render() }
      if(view==='profile'){ renderProfile() }
      if(view==='products'){ renderProductsTable() }
      if(view==='mycart'){ renderCart() }
      if(view==='myorders'){ renderOrders() }
      if(view==='settings'){ renderSettingsProfile() }
    }

    // Render products grid & KPIs
    function render(){
      const grid = el('#productGrid')
      grid.innerHTML = ''
      store.products.forEach(p=>{
        const box = document.createElement('div')
        box.className='product-box'
        box.innerHTML = `<div class="product-meta"><div class="product-name">${p.name}</div><div class="product-sku">${p.sku} ‚Ä¢ ${p.category}</div></div><div style="display:flex;align-items:center;gap:8px"><div class="qty-badge">${p.stock}</div><div><button class='btn ghost' data-action='edit' data-id='${p.id}'>Edit</button> <button class='btn ghost' data-action='adjust' data-id='${p.id}'>Adjust</button></div></div>`
        grid.appendChild(box)
      })
      // attach per-box handlers
      document.querySelectorAll('[data-action="edit"]').forEach(btn=>btn.addEventListener('click', (e)=>openModal('editProduct',Number(e.currentTarget.dataset.id))))
      document.querySelectorAll('[data-action="adjust"]').forEach(btn=>btn.addEventListener('click', (e)=>openModal('adjust',Number(e.currentTarget.dataset.id))))
      updateKPIs()
    }

    function updateKPIs(){
      el('#kpiproducts').textContent = store.products.length
      el('#kpilow').textContent = store.products.filter(p=>p.stock<=10).length
      el('#kpipendrec').textContent = store.receipts.filter(r=>r.status!=='Done').length
      el('#kpipenddel').textContent = store.deliveries.filter(d=>d.status!=='Done').length
      el('#kpitrans').textContent = store.transfers.length
    }

    // Render for Home consolidated view
    function renderHome(){
      // cards
      el('#home_kpiproducts').textContent = store.products.length
      el('#home_kpilow').textContent = store.products.filter(p=>p.stock<=10).length
      el('#home_kpipendrec').textContent = store.receipts.filter(r=>r.status!=='Done').length
      el('#home_kpipenddel').textContent = store.deliveries.filter(d=>d.status!=='Done').length
      el('#home_kpitrans').textContent = store.transfers.length

      // product grid
      const grid = el('#homeProductGrid')
      grid.innerHTML = ''
      store.products.forEach(p=>{
        const box = document.createElement('div')
        box.className='product-box'
        box.innerHTML = `<div class="product-meta"><div class="product-name">${p.name}</div><div class="product-sku">${p.sku} ‚Ä¢ ${p.category}</div></div><div style="display:flex;align-items:center;gap:8px"><div class="qty-badge">${p.stock}</div><div><button class='btn ghost' data-action='edit-h' data-id='${p.id}'>Edit</button> <button class='btn ghost' data-action='adjust-h' data-id='${p.id}'>Adjust</button></div></div>`
        grid.appendChild(box)
      })
      document.querySelectorAll('[data-action="edit-h"]').forEach(btn=>btn.addEventListener('click', (e)=>openModal('editProduct',Number(e.currentTarget.dataset.id))))
      document.querySelectorAll('[data-action="adjust-h"]').forEach(btn=>btn.addEventListener('click', (e)=>openModal('adjust',Number(e.currentTarget.dataset.id))))

      // receipts & deliveries quick lists
      const hr = el('#homeReceipts')
      const hd = el('#homeDeliveries')
      if(store.receipts.length===0){ hr.innerHTML = '<div class="muted">No recent receipts</div>' } else { hr.innerHTML = store.receipts.slice(-5).map(r=>`<div style="padding:6px 0">${r.qty} √ó ${(store.products.find(p=>p.id===r.product_id)||{}).name} ‚Äî ${r.supplier}</div>`).join('') }
      if(store.deliveries.length===0){ hd.innerHTML = '<div class="muted">No recent deliveries</div>' } else { hd.innerHTML = store.deliveries.slice(-5).map(d=>`<div style="padding:6px 0">${d.qty} √ó ${(store.products.find(p=>p.id===d.product_id)||{}).name} ‚Äî ${d.customer}</div>`).join('') }
    }

    // Products table render (for products view)
    function renderProductsTable(){
      const tbody = el('#productTable tbody')
      tbody.innerHTML=''
      store.products.forEach(p=>{
        const tr = document.createElement('tr')
        tr.innerHTML=`<td>${p.name}</td><td>${p.sku}</td><td>${p.category}</td><td>${p.unit}</td><td>${p.stock}</td>
        <td><button class='btn ghost' data-action='edit-t' data-id='${p.id}'>Edit</button> <button class='btn ghost' data-action='adjust-t' data-id='${p.id}'>Adjust</button></td>`
        tbody.appendChild(tr)
      })
      // attach table button handlers
      document.querySelectorAll('[data-action="edit-t"]').forEach(btn=>btn.addEventListener('click', (e)=>openModal('editProduct',Number(e.currentTarget.dataset.id))))
      document.querySelectorAll('[data-action="adjust-t"]').forEach(btn=>btn.addEventListener('click', (e)=>openModal('adjust',Number(e.currentTarget.dataset.id))))
      updateKPIs()
    }

    // Profile rendering
    function renderProfile(){
      const u = store.user
      const initials = (u.name||'').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase() || 'U'
      const avatarEl = el('#avatar')
      if(u.avatar){ avatarEl.style.backgroundImage = `url(${u.avatar})`; avatarEl.style.backgroundSize='cover'; avatarEl.textContent = '' } else { avatarEl.style.backgroundImage=''; avatarEl.textContent = initials }
      el('#u_name').textContent = u.name
      el('#u_role').textContent = u.role
      el('#u_name_f').textContent = u.name
      el('#u_email_f').textContent = u.email
      el('#u_role_f').textContent = u.role
      el('#u_bio_f').textContent = u.bio
      el('#pw_changed').textContent = u.password_changed

      // also update settings quick profile (profile under settings)
      el('#settings_name').textContent = u.name
      el('#settings_role').textContent = u.role
      const settingsAvatar = el('#settings_avatar')
      settingsAvatar.textContent = initials

      const activity = el('#activityList')
      activity.innerHTML = ''
      store.history.slice().reverse().forEach(h=>{
        const d = document.createElement('div')
        d.style.padding='8px'; d.style.borderBottom='1px solid #f1f5f9'
        d.innerHTML = `<div style="font-size:13px;color:var(--muted)">${h.type.toUpperCase()}</div><div style="font-weight:600">${h.text}</div>`
        activity.appendChild(d)
      })
    }

    // Modal manager (with live qty display beside stock input)
    function openModal(type,id){
      const modalBack = el('#modalBack')
      const modalContent = el('#modalContent')
      modalBack.style.display='flex'
      let html = ''
      if(type==='product'){
        html = ` <h3>Add Product</h3>
          <div class='form-row'><input id='p_name' placeholder='Name' /><input id='p_sku' placeholder='SKU' /></div>
          <div class='form-row'><select id='p_cat'><option value='raw'>Raw Material</option><option value='finished'>Finished Goods</option></select><input id='p_unit' placeholder='Unit (kg/pcs/box)' /></div>
          <div class='form-row'><input id='p_stock' type='number' placeholder='Initial stock (optional)' /> <div class="inline-qty">Qty live: <div class="qty-display" id="live_p_stock">0</div></div></div>
          <div style='text-align:right'><button class='btn ghost' id='cancelBtn'>Cancel</button> <button class='btn' id='saveProductBtn'>Save</button></div>`
      } else if(type==='editProduct'){
        const p = store.products.find(x=>x.id===id)
        html = `<h3>Edit Product</h3>
          <div class='form-row'><input id='p_name' value='${p.name}' placeholder='Name' /><input id='p_sku' value='${p.sku}'/></div>
          <div class='form-row'><select id='p_cat'><option value='raw' ${p.category==='raw'?'selected':''}>Raw Material</option><option value='finished' ${p.category==='finished'?'selected':''}>Finished Goods</option></select><input id='p_unit' value='${p.unit}' /></div>
          <div style='text-align:right'><button class='btn ghost' id='cancelBtn'>Cancel</button> <button class='btn' id='updateProductBtn'>Update</button></div>`
      } else if(type==='receipt'){
        html = `<h3>Create Receipt</h3>
          <div class='form-row'><input id='r_supplier' placeholder='Supplier name' /></div>
          <div class='form-row'><select id='r_product'>${store.products.map(p=>`<option value='${p.id}'>${p.name} ‚Äî ${p.sku}</option>`).join('')}</select><input id='r_qty' type='number' placeholder='Qty' /></div>
          <div style='text-align:right'><button class='btn ghost' id='cancelBtn'>Cancel</button> <button class='btn' id='saveReceiptBtn'>Receive</button></div>`
      } else if(type==='delivery'){
        html = `<h3>Create Delivery</h3>
          <div class='form-row'><input id='d_customer' placeholder='Customer name' /></div>
          <div class='form-row'><select id='d_product'>${store.products.map(p=>`<option value='${p.id}'>${p.name} ‚Äî ${p.sku} (stock:${p.stock})</option>`).join('')}</select><input id='d_qty' type='number' placeholder='Qty' /></div>
          <div style='text-align:right'><button class='btn ghost' id='cancelBtn'>Cancel</button> <button class='btn' id='saveDeliveryBtn'>Dispatch</button></div>`
      } else if(type==='adjust'){
        const p = store.products.find(x=>x.id===id)
        html = `<h3>Adjust Stock ‚Äî ${p.name}</h3>
          <div class='form-row'><input id='a_count' type='number' value='${p.stock}' /> <div class="inline-qty">Current: <div class="qty-display">${p.stock}</div></div></div>
          <div style='text-align:right'><button class='btn ghost' id='cancelBtn'>Cancel</button> <button class='btn' id='saveAdjustBtn'>Adjust</button></div>`
      } else if(type==='quick'){
        html = `<h3>Quick Actions</h3>
          <div class='form-row'><button class='btn' id='quickRecBtn'>Receive Goods</button><button class='btn' id='quickDelBtn'>Ship Goods</button></div>
          <div style='text-align:right'><button class='btn ghost' id='cancelBtn'>Close</button></div>`
      } else if(type==='editProfile'){
        const u = store.user
        html = `<h3>Edit Profile</h3>
          <div class='form-row'><input id='u_name_i' placeholder='Full name' value='${u.name}' /></div>
          <div class='form-row'><input id='u_email_i' placeholder='Email' value='${u.email}' /></div>
          <div class='form-row'><input id='u_role_i' placeholder='Role' value='${u.role}' /></div>
          <div class='form-row'><textarea id='u_bio_i' placeholder='Bio'>${u.bio}</textarea></div>
          <div class='form-row'><label style='width:120px'>Avatar</label><input id='u_avatar_i' type='file' accept='image/*' /></div>
          <div style='text-align:right'><button class='btn ghost' id='cancelBtn'>Cancel</button> <button class='btn' id='saveProfileBtn'>Save</button></div>`
      } else if(type==='changePassword'){
        html = `<h3>Change Password</h3>
          <div class='form-row'><input id='old_pw' type='password' placeholder='Current password' /></div>
          <div class='form-row'><input id='new_pw' type='password' placeholder='New password' /></div>
          <div class='form-row'><input id='new_pw2' type='password' placeholder='Confirm new password' /></div>
          <div style='text-align:right'><button class='btn ghost' id='cancelBtn'>Cancel</button> <button class='btn' id='changePasswordBtn'>Change</button></div>`
      }

      modalContent.innerHTML = html

      // wire up live qty display for Add Product modal
      const live = modalContent.querySelector('#p_stock')
      const liveDisplay = modalContent.querySelector('#live_p_stock')
      if(live && liveDisplay){
        live.addEventListener('input', ()=>{ liveDisplay.textContent = Number(live.value||0) })
        // initialize
        liveDisplay.textContent = Number(live.value||0)
      }

      // common cancel button
      const cancel = modalContent.querySelector('#cancelBtn')
      if(cancel) cancel.addEventListener('click', closeModal)

      // hook modal buttons to functions (bind current id where relevant)
      const saveBtn = modalContent.querySelector('#saveProductBtn')
      if(saveBtn) saveBtn.addEventListener('click', saveProduct)
      const updateBtn = modalContent.querySelector('#updateProductBtn')
      if(updateBtn) updateBtn.addEventListener('click', ()=>updateProduct(id))
      const saveRecBtn = modalContent.querySelector('#saveReceiptBtn')
      if(saveRecBtn) saveRecBtn.addEventListener('click', saveReceipt)
      const saveDelBtn = modalContent.querySelector('#saveDeliveryBtn')
      if(saveDelBtn) saveDelBtn.addEventListener('click', saveDelivery)
      const saveAdjBtn = modalContent.querySelector('#saveAdjustBtn')
      if(saveAdjBtn) saveAdjBtn.addEventListener('click', ()=>saveAdjustment(id))
      const quickRec = modalContent.querySelector('#quickRecBtn')
      if(quickRec) quickRec.addEventListener('click', ()=>{ closeModal(); openModal('receipt') })
      const quickDel = modalContent.querySelector('#quickDelBtn')
      if(quickDel) quickDel.addEventListener('click', ()=>{ closeModal(); openModal('delivery') })
      const saveProfileBtn = modalContent.querySelector('#saveProfileBtn')
      if(saveProfileBtn) saveProfileBtn.addEventListener('click', saveProfile)
      const changePwBtn = modalContent.querySelector('#changePasswordBtn')
      if(changePwBtn) changePwBtn.addEventListener('click', changePassword)

      // file input handler for avatar
      const fileInput = modalContent.querySelector('#u_avatar_i')
      if(fileInput){ fileInput.addEventListener('change', (e)=>{ const f = e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ()=>{ fileInput.dataset.preview = reader.result }; reader.readAsDataURL(f) }) }
    }

    function closeModal(){ el('#modalBack').style.display='none'; el('#modalContent').innerHTML = '' }

    // CRUD actions
    function saveProduct(){
      const nameEl = el('#p_name'); const skuEl = el('#p_sku'); const catEl = el('#p_cat'); const unitEl = el('#p_unit'); const stockEl = el('#p_stock')
      const name = nameEl ? nameEl.value.trim() : ''
      const sku = skuEl ? skuEl.value.trim() : ''
      const cat = catEl ? catEl.value : 'finished'
      const unit = unitEl ? unitEl.value.trim() : 'pcs'
      const stock = stockEl ? Number(stockEl.value||0) : 0
      if(!name||!sku){alert('Please provide name and SKU');return}
      const id = Date.now()
      store.products.push({id,name,sku,category:cat,unit,stock,locations:{main:stock,prod:0}})
      closeModal(); render(); renderProductsTable(); renderHome()
    }

    function updateProduct(id){
      const p = store.products.find(x=>x.id===id)
      if(!p) return
      const nameEl = el('#p_name'); const skuEl = el('#p_sku'); const catEl = el('#p_cat'); const unitEl = el('#p_unit')
      p.name = nameEl ? nameEl.value : p.name
      p.sku = skuEl ? skuEl.value : p.sku
      p.category = catEl ? catEl.value : p.category
      p.unit = unitEl ? unitEl.value : p.unit
      closeModal(); render(); renderProductsTable(); renderHome()
    }

    function saveReceipt(){
      const supplier = el('#r_supplier') ? el('#r_supplier').value||'Unknown' : 'Unknown'
      const pid = el('#r_product') ? Number(el('#r_product').value) : null
      const qty = el('#r_qty') ? Number(el('#r_qty').value||0) : 0
      if(!pid || qty<=0){alert('Enter valid product and qty');return}
      const product = store.products.find(p=>p.id===pid)
      const rec = {id:Date.now(),supplier,product_id:pid,qty,status:'Done'}
      store.receipts.push(rec)
      if(product){ product.stock += qty; product.locations.main = (product.locations.main||0)+qty }
      store.history.push({type:'receipt',text:`Received ${qty} √ó ${product ? product.name : 'Product #' + pid}`})
      closeModal(); render(); renderProductsTable(); renderHome()
    }

    function saveDelivery(){
      const cust = el('#d_customer') ? el('#d_customer').value||'Customer' : 'Customer'
      const pid = el('#d_product') ? Number(el('#d_product').value) : null
      const qty = el('#d_qty') ? Number(el('#d_qty').value||0) : 0
      if(!pid || qty<=0){alert('Enter valid product and qty');return}
      const product = store.products.find(p=>p.id===pid)
      if(product && product.stock<qty){alert('Not enough stock');return}
      const del = {id:Date.now(),customer:cust,product_id:pid,qty,status:'Done'}
      store.deliveries.push(del)
      if(product){ product.stock -= qty; product.locations.main = Math.max(0,(product.locations.main||0)-qty) }
      store.history.push({type:'delivery',text:`Shipped ${qty} √ó ${product ? product.name : 'Product #' + pid}`})
      closeModal(); render(); renderProductsTable(); renderHome()
    }

    function saveAdjustment(pid){
      const countedEl = el('#a_count')
      const counted = countedEl ? Number(countedEl.value||0) : 0
      const product = store.products.find(p=>p.id===pid)
      if(!product) return
      const diff = counted - product.stock
      product.stock = counted; product.locations.main = counted
      store.adjustments = store.adjustments||[]
      store.adjustments.push({id:Date.now(),product_id:pid,counted_qty:counted,difference:diff})
      store.history.push({type:'adjust',text:`Adjusted ${product.name} by ${diff}`})
      closeModal(); render(); renderProductsTable(); renderHome()
    }

    // Profile save
    function saveProfile(){
      const u = store.user
      const nameEl = el('#u_name_i'); const emailEl = el('#u_email_i'); const roleEl = el('#u_role_i'); const bioEl = el('#u_bio_i')
      u.name = nameEl ? nameEl.value.trim() || u.name : u.name
      u.email = emailEl ? emailEl.value.trim() || u.email : u.email
      u.role = roleEl ? roleEl.value.trim() || u.role : u.role
      u.bio = bioEl ? bioEl.value.trim() || u.bio : u.bio
      const fileInput = el('#modalContent').querySelector('#u_avatar_i')
      if(fileInput && fileInput.dataset && fileInput.dataset.preview){ u.avatar = fileInput.dataset.preview }
      u.password_changed = u.password_changed || new Date().toLocaleString()
      store.history.push({type:'profile',text:`Updated profile`})
      closeModal(); renderProfile(); alert('Profile saved (local demo)')
    }

    function changePassword(){
      const newpw = el('#new_pw') ? el('#new_pw').value : ''
      const newpw2 = el('#new_pw2') ? el('#new_pw2').value : ''
      if(!newpw||newpw.length<6){alert('New password must be at least 6 chars');return}
      if(newpw!==newpw2){alert('Passwords do not match');return}
      store.user.password_changed = new Date().toLocaleString()
      store.history.push({type:'security',text:'Changed password'})
      closeModal(); renderProfile(); alert('Password changed (demo)')
    }

    // Cart & Orders (simple demo implementations)
    function addToCart(productId, qty=1){
      const p = store.products.find(x=>x.id===productId)
      if(!p) return
      const existing = store.cart.find(c=>c.product_id===productId)
      if(existing){ existing.qty += qty } else { store.cart.push({product_id:productId,qty}) }
      renderCart(); renderHome()
    }

    function renderCart(){
      const list = el('#cartList')
      list.innerHTML = ''
      if(store.cart.length===0){ list.innerHTML = '<div class="muted">Cart is empty</div>'; el('#cartSummary').textContent='No items'; return }
      store.cart.forEach(item=>{
        const p = store.products.find(x=>x.id===item.product_id)
        const row = document.createElement('div')
        row.style.display='flex'; row.style.justifyContent='space-between'; row.style.padding='8px 0'; row.innerHTML = `<div>${p.name} <div class="muted" style="font-size:13px">${p.sku}</div></div><div style="display:flex;gap:8px;align-items:center"><div>${item.qty}</div><button class='btn ghost' data-action='remove-cart' data-id='${p.id}'>Remove</button></div>`
        list.appendChild(row)
      })
      document.querySelectorAll('[data-action="remove-cart"]').forEach(b=>b.addEventListener('click',(e)=>removeFromCart(Number(e.currentTarget.dataset.id))))
      el('#cartSummary').textContent = `${store.cart.length} item(s)`
    }

    function removeFromCart(id){ store.cart = store.cart.filter(c=>c.product_id!==id); renderCart(); renderHome() }

    function renderOrders(){
      const elOrders = el('#ordersList'); elOrders.innerHTML=''
      if(store.orders.length===0){ elOrders.innerHTML = '<div class="muted">No orders yet</div>'; return }
      store.orders.forEach(o=>{
        const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid #f1f5f9'; d.innerHTML = `<div style="font-weight:700">Order #${o.id}</div><div class="muted">Status: ${o.status}</div>`
        elOrders.appendChild(d)
      })
    }

    function renderSettingsProfile(){
      const u = store.user
      el('#settings_name').textContent = u.name
      el('#settings_role').textContent = u.role
      const sa = el('#settings_avatar')
      const initials = (u.name||'').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase()
      if(sa) sa.textContent = initials
    }

    // click outside to close modal
    el('#modalBack').addEventListener('click', (e)=>{ if(e.target.id==='modalBack') closeModal() })

    // search filter (affects table view only for simplicity)
    el('#search').addEventListener('input', ()=>{
      const q = el('#search').value.toLowerCase()
      const rows = Array.from(elAll('#productTable tbody tr'))
      rows.forEach(r=>{ r.style.display = (r.textContent.toLowerCase().includes(q)) ? '' : 'none' })
    })

    // initial render
    render();
    renderProductsTable();
    renderHome();
    // ensure dashboard visible
    switchView('dashboard')
  </script>
</body>
</html>
